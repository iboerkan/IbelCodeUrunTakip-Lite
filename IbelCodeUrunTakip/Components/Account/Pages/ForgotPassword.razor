@page "/forgot-password"
@rendermode InteractiveServer
@using IbelCode.Core.Models
@using Microsoft.AspNetCore.Identity
@using IbelCode.Data
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager NavManager
@inject IEmailSender<ApplicationUser> MailServisi
@layout AuthLayout
<div class="container d-flex justify-content-center align-items-center" style="min-height: 80vh;">
    <div class="card shadow-sm border-0" style="width: 400px;">
        <div class="card-body p-4 text-center">
            <i class="bi bi-envelope-check text-primary fs-1"></i>
            <h4 class="fw-bold mt-3">Şifremi Unuttum</h4>
            <p class="text-muted small">E-posta adresinizi girin, size bir sıfırlama bağlantısı gönderelim.</p>

            <div class="mb-3 text-start">
                <DxTextBox @bind-Text="@Email" NullText="E-posta adresiniz..." />
            </div>

            <DxButton Text="Sıfırlama Bağlantısı Gönder"
                      Click="@HandleResetRequest"
                      RenderStyle="ButtonRenderStyle.Primary"
                      CssClass="w-100 py-2"
                      Enabled="@(!IsLoading)" />

            @if (!string.IsNullOrEmpty(Message))
            {
                <div class="alert alert-info mt-3 small">@Message</div>
            }
        </div>
    </div>
</div>

@code {
    private string Email = "";
    private bool IsLoading = false;
    private string Message = "";

    private async Task HandleResetRequest()
    {
        if (string.IsNullOrEmpty(Email)) return;
        IsLoading = true;

        var user = await UserManager.FindByEmailAsync(Email);
        if (user != null)
        {
            // 1. Token Üret
            var token = await UserManager.GeneratePasswordResetTokenAsync(user);

            // 2. Linki Oluştur
            var resetLink = NavManager.ToAbsoluteUri($"/reset-password?token={Uri.EscapeDataString(token)}&email={Email}");

            // 3. E-posta Gönder (Şimdilik Console'a yazdıralım, aşağıda servisi kuracağız)
            Console.WriteLine($"Şifre Sıfırlama Linki: {resetLink}");
            await MailServisi.SendPasswordResetLinkAsync(user, Email, resetLink.AbsoluteUri);
            Message = "Eğer bu e-posta adresi kayıtlıysa, sıfırlama linki gönderilmiştir.";
        }
        else
        {
            // Güvenlik gereği kullanıcı yok dememek daha iyidir
            Message = "Eğer bu e-posta adresi kayıtlıysa, sıfırlama linki gönderilmiştir.";
        }
        IsLoading = false;
    }
}