@page "/sifre-guncelle"
@rendermode InteractiveServer
@using System.ComponentModel.DataAnnotations
@using IbelCode.Core.Models
@using IbelCode.Data
@using Microsoft.AspNetCore.Identity

@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthStateProvider
@attribute [Authorize]

<div class="container p-4">
    <div class="row justify-content-center">
        <div class="col-md-6 col-lg-5">
            <div class="card shadow border-0">
                <div class="card-header bg-primary text-white py-3">
                    <h5 class="mb-0 fw-bold"><i class="bi bi-shield-lock me-2"></i>Şifre Güncelleme</h5>
                </div>
                <div class="card-body p-4">
                    <EditForm Model="@PasswordModel" OnValidSubmit="@HandlePasswordChange">
                        <DataAnnotationsValidator />

                        @* Mevcut Şifre *@
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Mevcut Şifre</label>
                            <DxTextBox @bind-Text="@PasswordModel.OldPassword"
                                       Password="true"
                                       ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                                       NullText="Eski şifrenizi giriniz..." />
                            <ValidationMessage For="@(() => PasswordModel.OldPassword)" class="text-danger small" />
                        </div>

                        <hr class="my-4 opacity-25" />

                        @* Yeni Şifre *@
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Yeni Şifre</label>
                            <DxTextBox @bind-Text="@PasswordModel.NewPassword"
                                       Password="true"
                                       NullText="En az 6 karakter..." />
                            <ValidationMessage For="@(() => PasswordModel.NewPassword)" class="text-danger small" />
                        </div>

                        @* Yeni Şifre Tekrar *@
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Yeni Şifre Tekrar</label>
                            <DxTextBox @bind-Text="@PasswordModel.ConfirmPassword"
                                       Password="true"
                                       NullText="Yeni şifreyi tekrar giriniz..." />
                            <ValidationMessage For="@(() => PasswordModel.ConfirmPassword)" class="text-danger small" />
                        </div>

                        @* Durum Mesajları *@
                        @if (!string.IsNullOrEmpty(StatusMessage))
                        {
                            <div class="alert @(IsError ? "alert-danger" : "alert-success") py-2 shadow-sm border-0 animate__animated animate__fadeIn">
                                <i class="bi @(IsError ? "bi-x-circle" : "bi-check-circle") me-2"></i>
                                @StatusMessage
                            </div>
                        }

                        <div class="d-grid mt-4">
                            <DxButton Text="Şifreyi Güncelle"
                                      SubmitFormOnClick="true"
                                      RenderStyle="ButtonRenderStyle.Primary"
                                      IconCssClass="bi bi-arrow-repeat"
                                      Enabled="@(!IsProcessing)" />
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private ChangePasswordModel PasswordModel = new();
    private bool IsProcessing = false;
    private string StatusMessage = "";
    private bool IsError = false;

    private async Task HandlePasswordChange()
    {
        IsProcessing = true;
        StatusMessage = "";

        try
        {
            // 1. Mevcut kullanıcıyı al
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = await UserManager.GetUserAsync(authState.User);

            if (user == null)
            {
                IsError = true;
                StatusMessage = "Kullanıcı oturumu bulunamadı.";
                return;
            }

            // 2. Identity ile şifreyi değiştir
            var result = await UserManager.ChangePasswordAsync(user, PasswordModel.OldPassword, PasswordModel.NewPassword);

            if (result.Succeeded)
            {
                IsError = false;
                StatusMessage = "Şifreniz başarıyla değiştirildi.";
                PasswordModel = new(); // Formu temizle
            }
            else
            {
                IsError = true;
                StatusMessage = string.Join(" ", result.Errors.Select(e => e.Description));
            }
        }
        catch (Exception ex)
        {
            IsError = true;
            StatusMessage = "Bir hata oluştu: " + ex.Message;
        }
        finally
        {
            IsProcessing = false;
        }
    }
    public class ChangePasswordModel
    {
        [Required(ErrorMessage = "Mevcut şifrenizi girmeniz gerekiyor.")]
        public string OldPassword { get; set; } = "";

        [Required(ErrorMessage = "Yeni şifre boş bırakılamaz.")]
        [MinLength(6, ErrorMessage = "Şifre en az 6 karakter olmalıdır.")]
        public string NewPassword { get; set; } = "";

        [Compare(nameof(NewPassword), ErrorMessage = "Şifreler birbiriyle uyuşmuyor.")]
        public string ConfirmPassword { get; set; } = "";
    }
}