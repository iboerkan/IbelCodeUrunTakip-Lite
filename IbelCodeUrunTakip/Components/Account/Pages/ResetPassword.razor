@page "/reset-password"
@rendermode InteractiveServer
@using IbelCode.Core.Models
@using Microsoft.AspNetCore.Identity
@using IbelCode.Data
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager NavManager
@layout AuthLayout
@inject AuthenticationStateProvider AuthStateProvider

<div class="container d-flex justify-content-center align-items-center" style="min-height: 80vh;">
    <div class="card shadow-sm border-0" style="width: 400px;">
        <div class="card-body p-4">
            <h4 class="fw-bold text-center mb-4">Yeni Şifre Belirle</h4>

            <div class="mb-3">
                <label class="small fw-bold">Yeni Şifre</label>
                <DxTextBox @bind-Text="@NewPassword" Password="true" />
            </div>

            <div class="mb-3">
                <label class="small fw-bold">Şifre Tekrar</label>
                <DxTextBox @bind-Text="@ConfirmPassword" Password="true" />
            </div>

            <DxButton Text="Şifreyi Kaydet" Click="@HandleReset" RenderStyle="ButtonRenderStyle.Success" CssClass="w-100" />

            @if (!string.IsNullOrEmpty(Message))
            {
                <div class="alert mt-3 @(IsError ? "alert-danger" : "alert-success")">@Message</div>
            }
        </div>
        <div class="mt-4 border-top pt-3 text-center">
            <p class="text-muted small">Şifrenizi şimdi değiştirmek istemiyor musunuz?</p>

            <form action="/Account/Logout" method="post">
                <AntiforgeryToken />
                @* Çıkış yaptıktan sonra tekrar Login sayfasına gitsin *@
                <input type="hidden" name="returnUrl" value="/Account/Login" />

                <button type="submit" class="btn btn-outline-secondary btn-sm">
                    <i class="bi bi-box-arrow-right me-1"></i> Güvenli Çıkış Yap ve Sonra Dene
                </button>
            </form>
        </div>
    </div>

</div>

@code {
    [Parameter, SupplyParameterFromQuery] public string? Token { get; set; }
    [Parameter, SupplyParameterFromQuery] public string? Email { get; set; }

    private string NewPassword = "";
    private string ConfirmPassword = "";
    private string Message = "";
    private bool IsError = false;

    private async Task HandleReset()
    {
        if (string.IsNullOrWhiteSpace(NewPassword) || NewPassword != ConfirmPassword)
        {
            Message = "Şifreler boş olamaz ve uyuşmalıdır.";
            IsError = true;
            return;
        }
        if (currentUser == null)
        {
            Message = "Oturum bilgisi alınamadı, lütfen tekrar giriş yapın.";
            IsError = true;
            return;
        }
        IdentityResult result;

        // EĞER ELİMİZDE TOKEN VARSA (Şifremi Unuttum Akışı - URL'den gelebilir)
        if (!string.IsNullOrEmpty(Token))
        {
            result = await UserManager.ResetPasswordAsync(currentUser, Token, NewPassword);
        }
        // EĞER TOKEN YOKSA (Zorunlu Şifre Değiştirme Akışı)
        else
        {
            // Admin tarafından atanan şifreyi bilmediğimiz için kaldırıp yeniden ekliyoruz
            var removeResult = await UserManager.RemovePasswordAsync(currentUser);
            if (!removeResult.Succeeded)
            {
                Message = "Eski şifre kaldırılamadı: " + string.Join(", ", removeResult.Errors.Select(e => e.Description));
                IsError = true;
                return;
            }
            result = await UserManager.AddPasswordAsync(currentUser, NewPassword);
        }

        if (result.Succeeded)
        {
            // 3. KRİTİK: Bayrağı kapat ve veritabanını güncelle
            currentUser.UpdatePassword = false;
            await UserManager.UpdateAsync(currentUser);

            Message = "Şifreniz başarıyla güncellendi. Ana sayfaya yönlendiriliyorsunuz...";
            IsError = false;
            StateHasChanged();

            await Task.Delay(2000);

            // 4. YÖNLENDİRME: Kullanıcı zaten login olduğu için direkt ana sayfaya!
            // Middleware artık engel olmayacak çünkü UpdatePassword = false oldu.
            NavManager.NavigateTo("/", forceLoad: true);
        }
        else
        {
            Message = "Hata: " + string.Join(", ", result.Errors.Select(e => e.Description));
            IsError = true;
        }
    }

    private ApplicationUser currentUser;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            currentUser = await UserManager.GetUserAsync(user);
    
        }
    }
}